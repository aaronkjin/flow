# Phase 7.2: Keyboard Navigation

## Goal

Add comprehensive keyboard navigation throughout the app so users can navigate lists, select items, and move between editor panels entirely with the keyboard.

## Design Principles

- **Discoverable but unobtrusive**: keyboard nav should work without any visible instructions cluttering the UI
- **Consistent**: same keys do the same thing everywhere (Up/Down to move, Enter to select)
- **Non-destructive**: keyboard nav must not interfere with existing keyboard controls (React Flow's delete keys, form input, text areas, etc.)
- **Visual feedback**: keyboard-focused items get a distinct **orange** indicator (`bg-orange-500/10` background + `border-l-2 border-orange-500`) — clearly distinguishable from the mouse hover (`hover:bg-muted/30`). This makes it obvious when the user is navigating via keyboard vs. mouse.

## Shared Hook: `useKeyboardNav`

Create a reusable hook at `src/hooks/use-keyboard-nav.ts`:

```typescript
interface UseKeyboardNavOptions {
  itemCount: number;
  onSelect: (index: number) => void;
  enabled?: boolean;  // default true; disable when a modal/dialog is open or focus is in an input
}

interface UseKeyboardNavReturn {
  focusedIndex: number;         // -1 means nothing focused
  setFocusedIndex: (i: number) => void;
  getItemProps: (index: number) => {
    "data-focused": boolean;
    onMouseEnter: () => void;    // set focusedIndex on hover
    onMouseLeave: () => void;    // clear focusedIndex
    onClick: () => void;         // select on click
    ref: (el: HTMLElement | null) => void;  // for scrollIntoView
  };
}
```

Behavior:
- **ArrowDown**: increment `focusedIndex` (wrap to 0 at end)
- **ArrowUp**: decrement `focusedIndex` (wrap to last item at start)
- **Enter**: call `onSelect(focusedIndex)` if focusedIndex >= 0
- **Escape**: reset focusedIndex to -1
- The hook should listen on `document` keydown, but ONLY when `enabled` is true
- The `enabled` flag should automatically be false when the active element is an `input`, `textarea`, `select`, or `[contenteditable]` — so typing in forms doesn't trigger navigation
- When `focusedIndex` changes via keyboard, scroll the focused element into view (smooth scroll)
- When mouse hovers a row, set `focusedIndex` to that row; when mouse leaves the table area, keep the index (don't reset — feels more natural)

## Pages That Get Keyboard Navigation

### 1. Workflows Page (`src/app/workflows/page.tsx`)

- **Up/Down**: move through workflow table rows
- **Enter**: navigate to the workflow editor (`/workflows/{id}`)
- **Keyboard-focused row visual**: `bg-orange-500/10` background + `border-l-2 border-orange-500` (distinct from mouse `hover:bg-muted/30`)
- Disable keyboard nav when the delete confirmation dialog is showing
- The DropdownMenu on the actions column should still work normally via click

### 2. Runs Page (`src/app/runs/page.tsx` + `src/components/run/run-list-table.tsx`)

- **Up/Down**: move through run table rows
- **Enter**: navigate to run detail (`/runs/{id}`)
- **Keyboard-focused row visual**: `bg-orange-500/10` background + `border-l-2 border-orange-500` (distinct from mouse `hover:bg-muted/30`)
- Disable keyboard nav when the filter Select is open
- The `RunListTable` component needs to accept optional keyboard nav props: `focusedIndex` and `getItemProps`

### 3. Review Queue Page (`src/app/review/page.tsx`)

- **Up/Down**: move through review table rows
- **Enter**: navigate to review detail (`/review/{runId}`)
- **Keyboard-focused row visual**: `bg-orange-500/10` background + `border-l-2 border-orange-500` (distinct from mouse `hover:bg-muted/30`)

### 4. Dashboard Page (`src/app/page.tsx`)

- **Up/Down**: move through recent runs table rows
- **Enter**: navigate to run detail (`/runs/{id}`)
- **Keyboard-focused row visual**: `bg-orange-500/10` background + `border-l-2 border-orange-500` (distinct from mouse `hover:bg-muted/30`)

### 5. Workflow Editor — Block Palette (`src/components/workflow-editor/block-palette.tsx`)

- **Up/Down**: move through palette items (across all categories, treating all items as a flat list)
- **Enter**: add the focused block to the canvas center (call `addNode` with a default position like `{ x: 300, y: 300 }`)
- **Keyboard-focused item visual**: `bg-orange-500/10` background + `border-l-2 border-orange-500` (distinct from mouse `hover:bg-muted/30`)
- Only active when the palette panel has focus (see editor zone nav below)

### 6. Workflow Editor — Zone Navigation (`src/app/workflows/new/page.tsx`, `src/app/workflows/[workflowId]/page.tsx`)

- **Left/Right arrows**: move focus between three editor zones: Blocks palette (left), Canvas (center), Config panel (right)
- Only active when no input/textarea is focused
- Visual indicator: the active zone gets a very subtle top border highlight or slightly different background tint
- When entering the Blocks palette zone, Up/Down navigates palette items
- When entering the Canvas zone, React Flow's built-in keyboard controls take over (arrow keys for panning, Delete for removing nodes)
- When entering the Config panel zone, Tab navigates between form fields as usual
- The zone concept is optional and should degrade gracefully — if the user clicks into a zone, that zone becomes active

## Files to Create

1. `src/hooks/use-keyboard-nav.ts` — the reusable keyboard navigation hook

## Files to Modify

2. `src/app/page.tsx` — add keyboard nav to recent runs table
3. `src/app/workflows/page.tsx` — add keyboard nav to workflows table
4. `src/app/runs/page.tsx` — add keyboard nav (pass props to RunListTable)
5. `src/components/run/run-list-table.tsx` — accept keyboard nav props, apply to rows
6. `src/app/review/page.tsx` — add keyboard nav to review table
7. `src/components/workflow-editor/block-palette.tsx` — add keyboard nav to palette items
8. `src/app/workflows/new/page.tsx` — add editor zone navigation
9. `src/app/workflows/[workflowId]/page.tsx` — add editor zone navigation

## Constraints

- **NO functionality changes**: all existing click handlers, navigation, API calls remain identical
- **NO layout changes**: keyboard nav only adds visual focus indicators and event listeners
- Keyboard nav must NOT fire when typing in inputs, textareas, selects, or any form field
- React Flow's built-in keyboard shortcuts (Delete/Backspace for node removal) must continue working
- The hook must clean up event listeners on unmount
- Keyboard nav must work alongside mouse — hovering with mouse updates focused index, keyboard arrows also update it

## Verification

- [ ] `npx tsc --noEmit` passes
- [ ] `npm run lint` passes
- [ ] Workflows page: Up/Down moves between rows, Enter opens workflow
- [ ] Runs page: Up/Down moves between rows, Enter opens run detail
- [ ] Review page: Up/Down moves between rows, Enter opens review
- [ ] Dashboard: Up/Down moves between recent runs, Enter opens run detail
- [ ] Block palette: Up/Down moves between blocks, Enter adds block to canvas
- [ ] Editor zones: Left/Right moves focus between palette, canvas, config panel
- [ ] Typing in inputs/textareas does NOT trigger keyboard navigation
- [ ] React Flow Delete key still works for removing nodes
- [ ] Escape clears the focused index
- [ ] Focused row scrolls into view when navigating with keyboard
- [ ] Mouse hover and keyboard nav work together without conflict
- [ ] Keyboard-focused rows show distinct orange tint (`bg-orange-500/10` + left border), NOT the same as mouse hover (`bg-muted/30`)
